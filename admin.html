<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Admin - Debug Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-100 p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        <header class="flex justify-between items-center bg-white p-6 rounded-xl shadow-sm mb-6">
            <h1 class="text-xl font-bold">Gestión Centralizada</h1>
            <button onclick="localStorage.clear(); location.href='index.html'" class="text-red-500 font-bold">Salir</button>
        </header>

        <div class="bg-white p-6 rounded-xl shadow-sm mb-8 border-l-4 border-indigo-500">
            <h2 class="font-bold mb-4 italic text-slate-600 underline">PASO 1: Crear nuevo trabajador</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <input type="text" id="addNombre" placeholder="Nombre Completo" class="p-2 border rounded">
                <input type="text" id="addUser" placeholder="Usuario (Cédula/DNI)" class="p-2 border rounded">
                <input type="password" id="addPass" placeholder="Contraseña" class="p-2 border rounded">
                <button onclick="crearTrabajador()" class="bg-indigo-600 text-white font-bold rounded py-2 hover:bg-indigo-700">
                    <i class="fas fa-plus mr-2"></i>Crear Trabajador
                </button>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="w-full text-left">
                <thead class="bg-slate-50 border-b">
                    <tr>
                        <th class="p-4 font-bold">Nombre del Trabajador</th>
                        <th class="p-4 text-right">Acción</th>
                    </tr>
                </thead>
                <tbody id="listaEmps"></tbody>
            </table>
        </div>

        <div id="modalC" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-lg rounded-xl overflow-hidden shadow-2xl">
                <div class="p-4 bg-indigo-600 text-white flex justify-between">
                    <h3 id="nEmp" class="font-bold">Expediente</h3>
                    <button onclick="cerrarModal()">✕</button>
                </div>
                <div id="lDocs" class="p-6 space-y-2 max-h-60 overflow-y-auto"></div>
                
                <div class="p-6 bg-slate-50 border-t">
                    <p class="text-xs font-bold mb-2">PASO 2: Subir PDF a este usuario</p>
                    <div class="flex gap-2">
                        <select id="tipoDocAdmin" class="flex-1 p-2 border rounded text-sm">
                            <option>Apta médica</option>
                            <option>Capacitaciones de PRL</option>
                            <option>Certificado de competencia</option>
                            <option>Capacitación de trabajos en altura</option>
                            <option>Acta de entrega de EPP</option>
                        </select>
                        <button onclick="document.getElementById('fileInput').click()" class="bg-emerald-600 text-white px-4 py-2 rounded text-sm font-bold">Subir</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" class="hidden" accept=".pdf" onchange="ejecutarSubidaAdmin(this)">

    <script>
        const API_BASE = "https://backend-kelvin-docus.onrender.com/api";
        let idUsuarioSeleccionado = null;

        async function cargarListaEmpleados() {
            try {
                const res = await fetch(`${API_BASE}/admin/empleados`, {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                });
                const emps = await res.json();
                document.getElementById('listaEmps').innerHTML = emps.map(e => `
                    <tr class="border-b hover:bg-slate-50">
                        <td class="p-4 font-medium">${e.nombre_completo}</td>
                        <td class="p-4 text-right">
                            <button onclick="abrirExpediente(${e.id}, '${e.nombre_completo}')" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded font-bold">Ver / Subir</button>
                        </td>
                    </tr>`).join('');
            } catch (e) { console.error("Error cargando lista", e); }
        }

        async function crearTrabajador() {
            const nombre = document.getElementById('addNombre').value;
            const user = document.getElementById('addUser').value;
            const pass = document.getElementById('addPass').value;

            console.log("Intentando enviar datos al servidor...");

            if(!nombre || !user || !pass) return alert("Faltan datos");

            try {
                const res = await fetch(`${API_BASE}/admin/crear-usuario`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token') 
                    },
                    body: JSON.stringify({ nombre_completo: nombre, username: user, password_hash: pass })
                });

                const data = await res.json();
                console.log("Respuesta del servidor:", data);

                if(res.ok) {
                    alert("✅ Éxito: Usuario creado");
                    document.getElementById('addNombre').value = "";
                    document.getElementById('addUser').value = "";
                    document.getElementById('addPass').value = "";
                    cargarListaEmpleados();
                } else {
                    alert(`❌ Error del Servidor: ${data.detalle || data.error}`);
                }
            } catch (e) {
                console.error("Error de conexión:", e);
                alert("❌ Error de conexión al servidor");
            }
        }

        async function abrirExpediente(id, nombre) {
            idUsuarioSeleccionado = id;
            document.getElementById('nEmp').innerText = nombre;
            document.getElementById('modalC').classList.remove('hidden');
            const res = await fetch(`${API_BASE}/admin/documentos/${id}`, {
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
            });
            const docs = await res.json();
            document.getElementById('lDocs').innerHTML = docs.length ? docs.map(d => `
                <div class="flex justify-between bg-white p-2 border rounded">
                    <span class="text-sm font-bold">${d.tipo_documento}</span>
                    <a href="${d.url_cloudinary}" target="_blank" class="text-indigo-600"><i class="fas fa-eye"></i></a>
                </div>`).join('') : '<p class="text-center text-slate-400">Sin documentos</p>';
        }

        async function ejecutarSubidaAdmin(input) {
            const file = input.files[0];
            const tipo = document.getElementById('tipoDocAdmin').value;
            if(!file) return;

            const formData = new FormData();
            formData.append('archivo', file);
            formData.append('tipo_documento', tipo);
            formData.append('usuario_id', idUsuarioSeleccionado);
            formData.append('nombre_user', document.getElementById('nEmp').innerText);

            try {
                const res = await fetch(`${API_BASE}/admin/subir-a-usuario`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
                    body: formData
                });
                if(res.ok) {
                    alert("✅ PDF cargado al expediente");
                    abrirExpediente(idUsuarioSeleccionado, document.getElementById('nEmp').innerText);
                } else {
                    alert("Error al subir");
                }
            } catch (e) { alert("Error de red"); }
            input.value = "";
        }

        function cerrarModal() { document.getElementById('modalC').classList.add('hidden'); }

        // Carga inicial
        window.onload = cargarListaEmpleados;
    </script>
</body>
</html>